(()=>{"use strict";function e(e){if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}class t{parse(e){return this.keys={},this.parseObject(e,[]),this.keys}parseObject(e,t){for(const s in e)this.parseValue(s,e[s],t)}parseValue(e,t,s){"string"==typeof t?this.pushValue(s.join("."),e,t):(s.push(e),this.parseObject(t,s),s.pop())}pushValue(e,t,s){e in this.keys||(this.keys[e]=[]),this.keys[e].push({source:this.normalizeSource(t),key:s})}normalizeSource(t){const s=e(t).replaceAll(/\[\[([a-z]\w*)\]\]/g,"(?<$1>.+?)").replaceAll(/\{\{([a-z]\w*)\}\}/g,"(?<$1>\\S+?)");return new RegExp(`^${s}$`)}}class s{static normalizePathList(t){return t.map((t=>{const s=e(t).replaceAll("/@d","/[\\w-]+?").replaceAll("/@p","(/[\\w-]+?)+").replaceAll("/@f","(/[\\w-]+?\\.\\w+?)?");return new RegExp(`^${s}$`)}))}static normalizeKeys(e){return(new t).parse(e)}static validateXpath(e){const t=[];return e.split(/(\[.+?\])/).forEach(((e,s)=>{s%2==0?t.push(this.validateXpathIdent(e)):t.push(this.validateXpathCond(e))})),t.join("")}static validateXpathIdent(e){return e.replaceAll(/#([\w-]+)/g,'[@id="$1"]').replaceAll(/\.([\w-]+)/g,'[contains(@class, "$1")]')}static validateXpathCond(e){return e.replaceAll(/(\d+):(\d+)/g,"(position() >= $1 and position() <= $2)").replaceAll(/(\d+),(\d+)/g,"position() = $1 or position() = $2").replaceAll(/,(\d+)/g," or position() = $1").replaceAll(/(\d+),/g,"position() = $1 or ")}}class n{parse(e){return this.rule=[],this.parseGroups(e),this.rule}createRuleGroup(e){return{includes:s.normalizePathList(e.includes),excludes:s.normalizePathList(e.excludes),nodes:[],transKeys:s.normalizeKeys(e.transKeys)}}parseGroups(e){for(const t of e){const e=this.createRuleGroup(t);this.rule.push(e),this.parseGroup(t,e)}}parseGroup(e,t){this.parseNodes(e.nodes,t.nodes,t.transKeys,[])}parseNodes(e,t,s,n){for(const r of e)this.parseNode(r,t,s,n)}parseNode(e,t,n,r){r.push(e.xpath),"key"in e?t.push(Object.assign(Object.assign({},e),{xpath:s.validateXpath(r.join("")),transKeys:n[e.key]})):this.parseNodes(e.nodes,t,n,r),r.pop()}}var r=function(e,t,s,n){return new(s||(s=Promise))((function(r,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function i(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,i)}l((n=n.apply(e,t||[])).next())}))};class a{static set(e,t){return r(this,void 0,void 0,(function*(){chrome.storage.local.set({[e]:t})}))}static get(e,t){return r(this,void 0,void 0,(function*(){const s=yield new Promise((t=>{chrome.storage.local.get(e,(s=>{t(s[e])}))}));return void 0===s?t:s}))}static remove(e){return r(this,void 0,void 0,(function*(){chrome.storage.local.remove(e)}))}}class o{parse(e){return this.trans={},this.parseObject(e,[]),this.trans}parseObject(e,t){for(const s in e)this.parseValue(s,e[s],t)}parseValue(e,t,s){s.push(e),"string"==typeof t?this.pushValue(s.join("."),t):this.parseObject(t,s),s.pop()}pushValue(e,t){this.trans[e]=t}}class i{static parse(){return e=this,t=void 0,n=function*(){const e=yield a.get("data");if(!e)return null;const t=JSON.parse(e);return{rules:this.parseRule(t.rules),trans:this.parseTrans(t.trans)}},new((s=void 0)||(s=Promise))((function(r,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function i(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,i)}l((n=n.apply(e,t||[])).next())}));var e,t,s,n}static parseRule(e){return(new n).parse(e)}static parseTrans(e){return(new o).parse(e)}}class l{static observe(e){new MutationObserver(e).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}}class c{static find(e){const t=[];for(const s of e){const e=this.query(s.xpath,s.multi);0!==e.length&&t.push({key:s.key,attribute:s.attribute,custom:s.custom,transKeys:s.transKeys,nodes:e})}return t}static query(e,t){let s;return s=e.startsWith("::")?e.slice(3):'div[@id="app"]/main[1]'+e,t?this.querySelectorAll(s):this.querySelector(s)}static querySelector(e){const t=this.evaluate(e,XPathResult.FIRST_ORDERED_NODE_TYPE);return t.singleNodeValue?[t.singleNodeValue]:[]}static querySelectorAll(e){const t=this.evaluate(e,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);return Array.from({length:t.snapshotLength},((e,s)=>t.snapshotItem(s)))}static evaluate(e,t){return document.evaluate(this.setSVGNamespace(e),document.body,this.nsResolver,t,null)}static setSVGNamespace(e){return e.replace(/\/svg.+$/g,(e=>e.replaceAll(/(?<=\/)\w+/g,(e=>`svg:${e}`))))}}c.nsResolver=e=>"svg"===e?"http://www.w3.org/2000/svg":null;const u=c;class h{constructor(e){this.rule=e}filter(){return this.pathname=location.pathname.replace(/\/$/,""),this.rule.filter(this.contains.bind(this)).map((e=>e.nodes)).flat()}contains(e){return this.includes(e.includes)&&this.excludes(e.excludes)}includes(e){return e.some((e=>e.test(this.pathname)))}excludes(e){return!this.includes(e)}}class p{parse(e){this.localizedResult=[];for(const t of e)t.key&&this.findSourceResultNode(t),t.custom&&this.applyCustomResultNode(t);return this.localizedResult}applyCustomResultNode(e){for(const t of e.nodes)this.applyCustomNode(t,e.custom)}applyCustomNode(e,t){e instanceof HTMLElement&&(e.style.cssText+=t)}findSourceResultNode(e){for(const t of e.nodes)this.findSourceNode(t,e)}findSourceNode(e,{key:t,transKeys:s,attribute:n}){const r=this.getText(e,n);if(null===r)return;const a=this.findKey(r,t,s);null!==a&&this.localizedResult.push(Object.assign(a,{node:e,attribute:n}))}getText(e,t){let s;return s=e instanceof Text?e.nodeValue:null!==t?e.getAttribute(t):e instanceof SVGElement?e.textContent:e.innerText,s?s.trim().toLowerCase():null}findKey(e,t,s){for(const n of s){const s=e.match(n.source);if(s)return{key:[t,n.key].join("."),placeholder:s.groups||{}}}return null}}class d{constructor(e){this.trans=e}translate(e){for(const t of e)this.translateNode(t)}translateNode(e){const t=this.getTransByKey(e.key,e.placeholder);this.setText(e.node,e.attribute,t)}getTransByKey(e,t){return this.trans[e].replaceAll(/\{\{\w+\}\}/g,(e=>{var s;return null!==(s=t[e.slice(2,-2)])&&void 0!==s?s:e}))}setText(e,t,s){e instanceof Text?e.nodeValue=s:null!==t?e.setAttribute(t,s):e instanceof SVGElement?e.textContent=s:e.innerText=s}}var f,y;class v{initialize(){return e=this,t=void 0,n=function*(){const e=yield i.parse();null!==e&&(console.log(e),this.ruleFilter=new h(e.rules),this.translator=new d(e.trans))},new((s=void 0)||(s=Promise))((function(r,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function i(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,i)}l((n=n.apply(e,t||[])).next())}));var e,t,s,n}observe(){l.observe(this.domChanged.bind(this))}domChanged(){const e=this.ruleFilter.filter(),t=u.find(e),s=(new p).parse(t);this.translator.translate(s),console.log(t),console.log(s)}}y=function*(){console.log("script injected!");const e=new v;yield e.initialize(),e.observe()},new((f=void 0)||(f=Promise))((function(e,t){function s(e){try{r(y.next(e))}catch(e){t(e)}}function n(e){try{r(y.throw(e))}catch(e){t(e)}}function r(t){var r;t.done?e(t.value):(r=t.value,r instanceof f?r:new f((function(e){e(r)}))).then(s,n)}r((y=y.apply(void 0,[])).next())}))})();