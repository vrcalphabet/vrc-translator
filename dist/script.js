(()=>{"use strict";var t=function(t,e,s,n){return new(s||(s=Promise))((function(r,i){function o(t){try{l(n.next(t))}catch(t){i(t)}}function a(t){try{l(n.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}))};class e{static set(e,s){return t(this,void 0,void 0,(function*(){chrome.storage.local.set({[e]:s})}))}static get(e,s){return t(this,void 0,void 0,(function*(){const t=yield new Promise((t=>{chrome.storage.local.get(e,(s=>{t(s[e])}))}));return void 0===t?s:t}))}static remove(e){return t(this,void 0,void 0,(function*(){chrome.storage.local.remove(e)}))}}class s{static validate(t){for(const e of t)this.validateGroup(e)}static validateGroup(t){this.validateNodes(t.nodes)}static validateNodes(t){for(const e of t)this.validateNode(e)}static validateNode(t){t.xpath=this.validateXpath(t.xpath)}static validateXpath(t){const e=[];return t.split(/(\[.+?\])/).forEach(((t,s)=>{s%2==0?e.push(this.validateXpathIdent(t)):e.push(this.validateXpathCond(t))})),e.join("")}static validateXpathIdent(t){return t.replaceAll(/#([\w-]+)/g,'[@id="$1"]').replaceAll(/\.([\w-]+)/g,'[contains(@class, "$1")]')}static validateXpathCond(t){return t.replaceAll(/(\d+):(\d+)/g,"(position() >= $1 and position() <= $2)").replaceAll(/(\d+),(\d+)/g,"position() = $1 or position() = $2").replaceAll(/,(\d+)/g," or position() = $1").replaceAll(/(\d+),/g,"position() = $1 or ")}}function n(t){if("string"!=typeof t)throw new TypeError("Expected a string");return t.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}class r{constructor(){}static getInstance(){return this.INSTANCE}parse(t){return this.rule=[],this.parseGroups(t),s.validate(this.rule),this.rule}createRuleGroup(t){return{includes:this.normalizePathList(t.includes),excludes:this.normalizePathList(t.excludes),nodes:[]}}normalizePathList(t){return t.map((t=>{const e=n(t).replaceAll("/@d","/[\\w-]+?").replaceAll("/@p","(/[\\w-]+?)+").replaceAll("/@f","(/[\\w-]+?\\.\\w+?)?");return new RegExp(`^${e}$`)}))}parseGroups(t){for(const e of t){const t=this.createRuleGroup(e);this.rule.push(t),this.parseGroup(e,t,[e.name])}}parseGroup(t,e,s){this.parseNodes(t.nodes,e.nodes,s,[])}parseNodes(t,e,s,n){for(const r of t)this.parseNode(r,e,s,n)}parseNode(t,e,s,n){null!==t.key&&s.push(t.key),n.push(t.xpath),"multi"in t?e.push(Object.assign(Object.assign({},t),{key:s.join("/"),xpath:n.join("")})):this.parseNodes(t.nodes,e,s,n),null!==t.key&&s.pop(),n.pop()}}r.INSTANCE=new r;const i=r;class o{constructor(){}static getInstance(){return this.INSTANCE}parse(t){return this.trans={},this.parseObject(t,[]),this.trans}parseObject(t,e){for(const s in t)this.parseValue(s,t[s],e)}parseValue(t,e,s){"string"==typeof e?this.pushValue(s.join("/"),t,e):(s.push(t),this.parseObject(e,s),s.pop())}pushValue(t,e,s){t in this.trans||(this.trans[t]=[]),this.trans[t].push({source:this.normalizeSource(e),trans:s})}includesFormat(t){return t.includes("%s")||t.includes("%S")}normalizeSource(t){if(this.includesFormat(t)){const e=n(t).replaceAll("%s","(.*?)").replaceAll("%S","(.*)");return new RegExp(`^${e}$`,"i")}return t}}o.INSTANCE=new o;const a=o;var l=function(t,e,s,n){return new(s||(s=Promise))((function(r,i){function o(t){try{l(n.next(t))}catch(t){i(t)}}function a(t){try{l(n.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}))};class c{static parseRule(){return l(this,void 0,void 0,(function*(){const t=yield e.get("rule");if(void 0===t)return null;const s=i.getInstance(),n=JSON.parse(t);return s.parse(n)}))}static parseTrans(){return l(this,void 0,void 0,(function*(){const t=yield e.get("trans");if(void 0===t)return null;const s=a.getInstance(),n=JSON.parse(t);return s.parse(n)}))}}class u{constructor(t){this.rule=t}filter(){return this.pathname=location.pathname.replace(/\/$/,""),this.rule.filter(this.contains.bind(this)).map((t=>t.nodes)).flat()}contains(t){return this.includes(t.includes)&&this.excludes(t.excludes)}includes(t){return t.some((t=>this.testRegEx(t,this.pathname)))}excludes(t){return!this.includes(t)}testRegEx(t,e){return t.test(e)}}class h{static observe(t){new MutationObserver(t).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}}class d{static find(t){const e=[];for(const s of t){const{key:t,xpath:n,multi:r,attribute:i,custom:o}=s,a=this.query(n,r);0!==a.length&&e.push({key:t,attribute:i,custom:o,nodes:a})}return e}static query(t,e){let s;return s=t.startsWith("::")?t.slice(3):'div[@id="app"]/main[1]'+t,e?this.querySelectorAll(s):this.querySelector(s)}static querySelector(t){const e=this.evaluate(t,XPathResult.FIRST_ORDERED_NODE_TYPE);return e.singleNodeValue?[e.singleNodeValue]:[]}static querySelectorAll(t){const e=this.evaluate(t,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);return Array.from({length:e.snapshotLength},((t,s)=>e.snapshotItem(s)))}static evaluate(t,e){return document.evaluate(this.setSVGNamespace(t),document.body,this.nsResolver,e,null)}static setSVGNamespace(t){return t.replace(/\/svg.+$/g,(t=>t.replaceAll(/(?<=\/)\w+/g,(t=>`svg:${t}`))))}}d.nsResolver=t=>"svg"===t?"http://www.w3.org/2000/svg":null;const p=d;class f{constructor(t){this.trans=t}translate(t){for(const e of t)/.+\/[^_]\w+$/.test(e.key)&&this.translateResultNode(e),this.applyCustomResultNode(e)}applyCustomResultNode(t){if(null!==t.custom)for(const e of t.nodes)this.applyCustomNode(e,t.custom)}applyCustomNode(t,e){t instanceof HTMLElement&&(t.style.cssText+=e)}translateResultNode(t){for(const e of t.nodes)this.translateNode(e,t.key,t.attribute)}translateNode(t,e,s){const n=this.getText(t,s);if(null===n)return;const r=this.findTrans(e,n);null!==r&&this.setText(t,s,r)}setText(t,e,s){t instanceof Text?t.nodeValue=s:null!==e?t.setAttribute(e,s):t instanceof SVGElement?t.textContent=s:t.innerText=s}getText(t,e){let s;return s=t instanceof Text?t.nodeValue:null!==e?t.getAttribute(e):t instanceof SVGElement?t.textContent:t.innerText,s?s.trim().toLowerCase():null}findTrans(t,e){return t in this.trans?this.findTransNodeList(this.trans[t],e):(console.error(`[${t}]の翻訳がありません！`),null)}findTransNodeList(t,e){for(const s of t){const t=this.findTransNode(s,e);if(null!==t)return t}return null}findTransNode(t,e){if(t.source instanceof RegExp){const s=e.match(t.source);return null===s?null:this.setCaptures(t.trans,s.slice(1))}return t.source===e?t.trans:null}setCaptures(t,e){return t.replaceAll(/\$(\d)/g,((t,s)=>e[s-1]))}}var v,g;class m{initialize(){return t=this,e=void 0,n=function*(){const t=yield c.parseRule();if(null===t)return;const e=yield c.parseTrans();null!==e&&(console.log(t),console.log(e),this.ruleFilter=new u(t),this.translator=new f(e))},new((s=void 0)||(s=Promise))((function(r,i){function o(t){try{l(n.next(t))}catch(t){i(t)}}function a(t){try{l(n.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}));var t,e,s,n}observe(){h.observe(this.domChanged.bind(this))}domChanged(){const t=this.ruleFilter.filter(),e=p.find(t);this.translator.translate(e)}}g=function*(){console.log("script injected!");const t=new m;yield t.initialize(),t.observe()},new((v=void 0)||(v=Promise))((function(t,e){function s(t){try{r(g.next(t))}catch(t){e(t)}}function n(t){try{r(g.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof v?r:new v((function(t){t(r)}))).then(s,n)}r((g=g.apply(void 0,[])).next())}))})();