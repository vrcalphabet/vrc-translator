(()=>{"use strict";var t=function(t,e,n,s){return new(n||(n=Promise))((function(r,i){function o(t){try{l(s.next(t))}catch(t){i(t)}}function a(t){try{l(s.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))};class e{static set(e,n){return t(this,void 0,void 0,(function*(){chrome.storage.local.set({[e]:n})}))}static get(e,n){return t(this,void 0,void 0,(function*(){const t=yield new Promise((t=>{chrome.storage.local.get(e,(n=>{t(n[e])}))}));return void 0===t?n:t}))}static remove(e){return t(this,void 0,void 0,(function*(){chrome.storage.local.remove(e)}))}}class n{static validate(t){for(const e of t)this.validateGroup(e)}static validateGroup(t){this.validateNodes(t.nodes)}static validateNodes(t){for(const e of t)this.validateNode(e)}static validateNode(t){t.xpath=this.validateXpath(t.xpath)}static validateXpath(t){const e=[];return t.split(/(\[.+?\])/).forEach(((t,n)=>{n%2==0?e.push(this.validateXpathIdent(t)):e.push(this.validateXpathCond(t))})),e.join("")}static validateXpathIdent(t){return t.replaceAll(/#([\w-]+)/g,'[@id="$1"]').replaceAll(/\.([\w-]+)/g,'[contains(@class, "$1")]')}static validateXpathCond(t){return t.replaceAll(/(\d+):(\d+)/g,"(position() >= $1 and position() <= $2)").replaceAll(/(\d+),(\d+)/g,"position() = $1 or position() = $2").replaceAll(/,(\d+)/g," or position() = $1").replaceAll(/(\d+),/g,"position() = $1 or ")}}class s{constructor(){}static getInstance(){return this.INSTANCE}parse(t){return this.rule=[],this.parseGroups(t),n.validate(this.rule),this.rule}createRuleGroup(t){return{includes:t.includes,excludes:t.excludes,nodes:[]}}parseGroups(t){for(const e of t){const t=this.createRuleGroup(e);this.rule.push(t),this.parseGroup(e,t,[e.name])}}parseGroup(t,e,n){this.parseNodes(t.nodes,e.nodes,n,[])}parseNodes(t,e,n,s){for(const r of t)this.parseNode(r,e,n,s)}parseNode(t,e,n,s){null!==t.key&&n.push(t.key),s.push(t.xpath),"multi"in t?e.push(Object.assign(Object.assign({},t),{key:n.join("/"),xpath:s.join("")})):this.parseNodes(t.nodes,e,n,s),null!==t.key&&n.pop(),s.pop()}}s.INSTANCE=new s;const r=s;class i{constructor(){}static getInstance(){return this.INSTANCE}parse(t){return this.trans={},this.parseObject(t,[]),this.trans}parseObject(t,e){for(const n in t)this.parseValue(n,t[n],e)}parseValue(t,e,n){"string"==typeof e?this.pushValue(n.join("/"),t,e):(n.push(t),this.parseObject(e,n),n.pop())}pushValue(t,e,n){t in this.trans||(this.trans[t]=[]),this.trans[t].push({source:e,trans:n})}}i.INSTANCE=new i;const o=i;var a=function(t,e,n,s){return new(n||(n=Promise))((function(r,i){function o(t){try{l(s.next(t))}catch(t){i(t)}}function a(t){try{l(s.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))};class l{static parseRule(){return a(this,void 0,void 0,(function*(){const t=yield e.get("rule");if(void 0===t)return null;const n=r.getInstance(),s=JSON.parse(t);return n.parse(s)}))}static parseTrans(){return a(this,void 0,void 0,(function*(){const t=yield e.get("trans");if(void 0===t)return null;const n=o.getInstance(),s=JSON.parse(t);return n.parse(s)}))}}class c{constructor(t){this.rule=t}filter(){return this.pathname=location.pathname.replace(/\/$/,""),this.rule.filter(this.contains.bind(this)).map((t=>t.nodes)).flat()}contains(t){return this.includes(t.includes)&&!this.excludes(t.excludes)}includes(t){return t.includes(this.pathname)}excludes(t){return t.includes(this.pathname)}}class u{static observe(t){new MutationObserver(t).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}}class h{static find(t){const e=[];for(const n of t){const{key:t,xpath:s,multi:r,attribute:i}=n,o=this.query(s,r);0!==o.length&&e.push({key:t,attribute:i,nodes:o})}return e}static query(t,e){const n='div[@id="app"]/main[1]'+t;return e?this.querySelectorAll(n):this.querySelector(n)}static querySelector(t){const e=this.evaluate(t,XPathResult.FIRST_ORDERED_NODE_TYPE);return e.singleNodeValue?[e.singleNodeValue]:[]}static querySelectorAll(t){const e=this.evaluate(t,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);return Array.from({length:e.snapshotLength},((t,n)=>e.snapshotItem(n)))}static evaluate(t,e){return document.evaluate(t,document.body,null,e,null)}}class d{constructor(t){this.trans=t}translate(t){for(const e of t)this.translateResultNode(e)}translateResultNode(t){for(const e of t.nodes)this.translateNode(e,t.key,t.attribute)}translateNode(t,e,n){const s=this.getText(t,n);if(null===s)return;const r=this.findTrans(e,s);null!==r&&this.setText(t,n,r)}setText(t,e,n){t instanceof Text?t.nodeValue=n:null!==e?t.setAttribute(e,n):t.innerText=n}getText(t,e){let n;return n=t instanceof Text?t.nodeValue:null!==e?t.getAttribute(e):t.innerText,n?n.trim():null}findTrans(t,e){return this.findTransNodeList(this.trans[t],e)}findTransNodeList(t,e){for(const n of t){const t=this.findTransNode(n,e);if(null!==t)return t}return null}findTransNode(t,e){return t.source.toLowerCase()===e.toLowerCase()?t.trans:null}}var p,f;class v{initialize(){return t=this,e=void 0,s=function*(){const t=yield l.parseRule();if(null===t)return;const e=yield l.parseTrans();null!==e&&(console.log(t),console.log(e),this.ruleFilter=new c(t),this.translator=new d(e))},new((n=void 0)||(n=Promise))((function(r,i){function o(t){try{l(s.next(t))}catch(t){i(t)}}function a(t){try{l(s.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}));var t,e,n,s}observe(){u.observe(this.domChanged.bind(this))}domChanged(){const t=this.ruleFilter.filter(),e=h.find(t);this.translator.translate(e),console.log(t),console.log(e)}}f=function*(){console.log("script injected!");const t=new v;yield t.initialize(),t.observe()},new((p=void 0)||(p=Promise))((function(t,e){function n(t){try{r(f.next(t))}catch(t){e(t)}}function s(t){try{r(f.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof p?r:new p((function(t){t(r)}))).then(n,s)}r((f=f.apply(void 0,[])).next())}))})();